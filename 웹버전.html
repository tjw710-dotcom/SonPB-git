<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6월 소비 건강 진단 - 손PB</title>
    <style>
        /* 기본 스타일 및 폰트 설정 */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        
        :root {
            --primary-color: #007aff;
            --danger-color: #ff3b30;
            --warning-color: #ff9500;
            --success-color: #34c759;
            --muted-foreground: #8a8a8e;
            --card-border: #e5e5ea;
            --background: #f0f2f5;
        }

        body {
            background-color: var(--background);
            font-family: 'Noto Sans KR', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #1c1c1e;
        }

        /* 스마트폰 프레임 */
        .phone-container {
            width: 375px;
            height: 812px;
            background-color: #ffffff;
            border-radius: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* 메인 콘텐츠 영역 */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            padding-bottom: 80px; /* 하단 네비게이션 공간 확보 */
        }
        
        .content::-webkit-scrollbar {
            display: none;
        }

        /* 공통 카드 스타일 */
        .card {
            background-color: #ffffff;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--card-border);
        }

        .card-header {
            padding-bottom: 12px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* 상단 히어로 요약 */
        .hero-summary {
            border-radius: 24px;
            padding: 16px;
            background: linear-gradient(135deg, #fff7e6, #ffffff);
            border: 1px solid #ffeacc;
            margin-bottom: 16px;
        }
        .hero-summary .total-spending {
            font-size: 26px;
            font-weight: 800;
        }
        .hero-summary .badge {
            background-color: #fff1d6;
            color: #d97706;
            font-size: 12px;
            font-weight: 500;
            padding: 4px 10px;
            border-radius: 9999px;
        }
        .hero-summary .muted-text {
            font-size: 12px;
            color: var(--muted-foreground);
        }

        /* 탭 네비게이션 */
        .tabs {
            position: sticky;
            top: 0;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(8px);
            z-index: 10;
            padding: 8px 0;
        }
        .tab-list {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            width: 100%;
            background-color: #f0f2f5;
            border-radius: 10px;
            padding: 4px;
        }
        .tab-trigger {
            border: none;
            background: none;
            padding: 8px 12px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            color: #555;
        }
        .tab-trigger.active {
            background-color: #ffffff;
            color: #000;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .tab-content {
            display: none;
            padding-top: 16px;
        }
        .tab-content.active {
            display: block;
        }

        /* ======================================== */
        /* ✨ 소비 현황 탭 스타일 (수정됨)        */
        /* ======================================== */
        .spending-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-top: 8px;
        }
        .spending-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .spending-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }
        .spending-item-category {
            font-weight: 500;
        }
        .spending-item-amount-wrapper { /* 금액과 퍼센트를 묶는 래퍼 */
            display: flex;
            align-items: baseline;
            gap: 6px;
        }
        .spending-item-amount {
            font-weight: 700;
        }
        .spending-item-percentage { /* 퍼센트 스타일 추가 */
            font-size: 12px;
            font-weight: 500;
            color: var(--muted-foreground);
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #f0f2f5;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 4px;
            transition: width 0.5s ease-in-out;
        }
        .spending-item:nth-child(1) .progress-bar-fill { background-color: #ff3b30; } /* 온라인쇼핑 */
        .spending-item:nth-child(2) .progress-bar-fill { background-color: #ff9500; } /* 금융 */
        .spending-item:nth-child(3) .progress-bar-fill { background-color: #ffcc00; } /* 생활 */
        .spending-item:nth-child(4) .progress-bar-fill { background-color: #34c759; } /* 자동차 */
        .spending-item:nth-child(5) .progress-bar-fill { background-color: #5856d6; } /* 의료/건강 */

        /* 분석/평가 탭: 소비 목표 및 솔루션 */
        .goal-solution-item {
            padding: 12px;
            background-color: #f9fafb;
            border-radius: 12px;
            border: 1px solid var(--card-border);
            margin-bottom: 16px;
        }
        .goal-solution-item:last-child {
            margin-bottom: 0;
        }
        .goal-item-header {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .spending-comparison {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            font-size: 14px;
        }
        .spending-comparison .amount {
            font-weight: 500;
        }
        .spending-comparison .arrow {
            font-size: 20px;
            color: var(--muted-foreground);
        }
        .savings-effect {
            margin-top: 8px;
            text-align: right;
            font-size: 14px;
            font-weight: 700;
            color: var(--primary-color);
        }
        .solution-divider {
            height: 1px;
            background-color: var(--card-border);
            margin: 12px 0;
        }
        .solution-item { display: flex; align-items: center; justify-content: space-between; text-decoration: none; color: inherit; }
        .solution-item .emoji-bg { width: 32px; height: 32px; border-radius: 8px; background-color: #f3f4f6; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .solution-item .link-text { color: var(--primary-color); font-size: 12px; font-weight: 500; }

        /* 분석/평가 탭: 장기 목표 */
        .long-term-goal .goal-item { margin-bottom: 24px; }
        .long-term-goal .goal-item:last-child { margin-bottom: 0; }
        .long-term-goal .goal-item h3 { font-size: 16px; font-weight: 700; margin: 0 0 4px; }
        .long-term-goal .goal-reason { font-size: 14px; color: var(--muted-foreground); margin-bottom: 10px; line-height: 1.5; }
        .long-term-goal .race-track {
            position: relative;
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            margin-top: 16px;
            margin-bottom: 8px;
        }
        .long-term-goal .progress-line {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            border-radius: 4px;
        }
        .long-term-goal .tortoise, .long-term-goal .hare {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
            line-height: 1;
        }
        .long-term-goal .hare {
            right: 0;
        }
        .long-term-goal .race-progress-text {
            font-size: 12px;
            color: var(--muted-foreground);
            text-align: right;
        }
        
        /* 거북이 애니메이션 */
        @keyframes crawl {
            0%, 100% {
                transform: translateY(-50%) rotate(-5deg);
            }
            50% {
                transform: translateY(-50%) rotate(5deg);
            }
        }
        .long-term-goal .tortoise {
            animation: crawl 1.5s ease-in-out infinite;
        }


        /* 상품 추천 탭: 카드 추천 */
        .product-card { border-radius: 16px; border: 1px solid var(--card-border); padding: 12px; }
        .card-design { border-radius: 12px; height: 100px; padding: 16px; color: white; display: flex; flex-direction: column; justify-content: flex-end; }
        .card-design .brand { font-size: 14px; opacity: 0.8; }
        .card-design .name { font-size: 18px; font-weight: 700; letter-spacing: 0.5px; }
        
        /* 상단 알림 & AI 종합 진단 */
        .alert {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            background-color: #fffbeb;
            border: 1px solid #fde68a;
            color: #b45309;
            padding: 12px;
            border-radius: 12px;
            font-size: 14px;
            margin-bottom: 16px;
            min-height: 60px;
        }
        .alert-title { font-weight: 700; display: flex; align-items: center; justify-content: space-between;}
        .tts-button { background: none; border: none; cursor: pointer; padding: 0; margin-left: 8px; color: #b45309; opacity: 0.7;}
        .tts-button:hover { opacity: 1; }

        /* Gemini AI 챌린지 카드 */
        .ai-challenge-card .challenge-content {
            min-height: 100px;
            padding: 12px;
            border-radius: 12px;
            background-color: #f0f5ff;
            border: 1px dashed #b3c5ff;
        }
        .ai-challenge-card .challenge-title {
            font-weight: 700;
            font-size: 15px;
            margin-bottom: 4px;
        }
        .ai-challenge-card .challenge-description {
            font-size: 14px;
            color: #333;
            margin-bottom: 12px;
        }
        .ai-challenge-card .challenge-tips {
            list-style-position: inside;
            padding-left: 4px;
            font-size: 13px;
            color: #555;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 14px;
            color: var(--muted-foreground);
        }

        /* 하단 네비게이션 바 */
        .bottom-nav {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background-color: #ffffff;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid var(--card-border);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--muted-foreground);
            font-size: 11px;
            font-weight: 500;
            text-decoration: none;
        }
        .nav-item.active {
            color: var(--primary-color);
        }
        .nav-item svg {
            width: 24px;
            height: 24px;
        }

    </style>
</head>
<body>
    <div class="phone-container">
        <div class="content">
            <div class="hero-summary">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div>
                        <p class="muted-text">이번 달 총지출</p>
                        <div class="total-spending">₩2,429,616</div>
                    </div>
                    <div class="badge">온라인 소비 중심</div>
                </div>
                <div style="margin-top: 8px; display: flex; align-items: center; justify-content: space-between;" class="muted-text">
                    <span>여윳돈 예상 ₩-492,222</span>
                    <span>전월 대비 +12%</span>
                </div>
            </div>

            <div class="tabs">
                <div class="tab-list">
                    <button class="tab-trigger active" onclick="switchTab(event, 'overview')">소비 현황</button>
                    <button class="tab-trigger" onclick="switchTab(event, 'savings')">분석/평가</button>
                    <button class="tab-trigger" onclick="switchTab(event, 'tools')">상품 추천</button>
                </div>
            </div>

            <div id="overview" class="tab-content active">
                <div class="card">
                    <div class="card-header"><h2 class="card-title">📊 카테고리별 소비 상세</h2></div>
                    <div class="spending-list">
                        <div class="spending-item">
                            <div class="spending-item-header">
                                <span class="spending-item-category">🛒 온라인쇼핑</span>
                                <div class="spending-item-amount-wrapper">
                                    <span class="spending-item-amount">₩490,826</span>
                                    <span class="spending-item-percentage">(20.2%)</span>
                                </div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-bar-fill" style="width: 20.2%;"></div>
                            </div>
                        </div>
                        <div class="spending-item">
                            <div class="spending-item-header">
                                <span class="spending-item-category">💳 금융</span>
                                <div class="spending-item-amount-wrapper">
                                    <span class="spending-item-amount">₩473,583</span>
                                    <span class="spending-item-percentage">(19.5%)</span>
                                </div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-bar-fill" style="width: 19.5%;"></div>
                            </div>
                        </div>
                        <div class="spending-item">
                            <div class="spending-item-header">
                                <span class="spending-item-category">🏠 생활</span>
                                <div class="spending-item-amount-wrapper">
                                    <span class="spending-item-amount">₩297,863</span>
                                    <span class="spending-item-percentage">(12.3%)</span>
                                </div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-bar-fill" style="width: 12.3%;"></div>
                            </div>
                        </div>
                        <div class="spending-item">
                            <div class="spending-item-header">
                                <span class="spending-item-category">🚗 자동차</span>
                                <div class="spending-item-amount-wrapper">
                                    <span class="spending-item-amount">₩289,437</span>
                                    <span class="spending-item-percentage">(11.9%)</span>
                                </div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-bar-fill" style="width: 11.9%;"></div>
                            </div>
                        </div>
                        <div class="spending-item">
                            <div class="spending-item-header">
                                <span class="spending-item-category">💪 의료/건강</span>
                                <div class="spending-item-amount-wrapper">
                                    <span class="spending-item-amount">₩216,333</span>
                                    <span class="spending-item-percentage">(8.9%)</span>
                                </div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-bar-fill" style="width: 8.9%;"></div>
                            </div>
                        </div>
                        <div class="spending-item">
                            <div class="spending-item-header">
                                <span class="spending-item-category">☕ 카페/간식</span>
                                <div class="spending-item-amount-wrapper">
                                    <span class="spending-item-amount">₩157,800</span>
                                    <span class="spending-item-percentage">(6.5%)</span>
                                </div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-bar-fill" style="width: 6.5%;"></div>
                            </div>
                        </div>
                        <div class="spending-item">
                            <div class="spending-item-header">
                                <span class="spending-item-category">🍔 식비</span>
                                <div class="spending-item-amount-wrapper">
                                    <span class="spending-item-amount">₩153,459</span>
                                    <span class="spending-item-percentage">(6.3%)</span>
                                </div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-bar-fill" style="width: 6.3%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="savings" class="tab-content">
                <div id="ai-summary-container" class="alert">
                    <div class="loading-spinner" style="width: 100%;">✨ AI가 소비 데이터를 분석하고 있어요...</div>
                </div>
                <div class="card">
                    <div class="card-header"><h2 class="card-title">🎯 소비 목표 및 솔루션</h2></div>
                    <div class="goal-solution-item">
                        <div class="goal-item-header">🛒 인터넷쇼핑</div>
                        <div class="spending-comparison">
                            <div class="amount">현재 ₩337,026</div>
                            <div class="arrow">➡️</div>
                            <div class="amount">목표 ₩250,000</div>
                        </div>
                        <div class="savings-effect">월 87,026원 절약</div>
                        <div class="solution-divider"></div>
                        <a href="#" class="solution-item">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="emoji-bg">🛒</div>
                                <div>
                                    <div style="font-size: 14px; font-weight: 500;">온라인 쇼핑(쿠팡)</div>
                                    <div style="font-size: 12px; color: var(--muted-foreground);">월 10% 절감 시 연 86만원 절약</div>
                                </div>
                            </div>
                            <span class="link-text">바로가기</span>
                        </a>
                    </div>
                    <div class="goal-solution-item">
                        <div class="goal-item-header">💳 서비스구독</div>
                        <div class="spending-comparison">
                            <div class="amount">현재 ₩93,800</div>
                            <div class="arrow">➡️</div>
                            <div class="amount">목표 ₩65,000</div>
                        </div>
                        <div class="savings-effect">월 28,800원 절약</div>
                        <div class="solution-divider"></div>
                         <a href="#" class="solution-item">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="emoji-bg">🧑‍🏫</div>
                                <div>
                                    <div style="font-size: 14px; font-weight: 500;">구독 서비스 할인 찾기</div>
                                    <div style="font-size: 12px; color: var(--muted-foreground);">교직원 대상 OTT/소프트웨어 할인 확인</div>
                                </div>
                            </div>
                            <span class="link-text">바로가기</span>
                        </a>
                    </div>
                    <div class="goal-solution-item">
                        <div class="goal-item-header">☕ 카페/간식</div>
                        <div class="spending-comparison">
                            <div class="amount">현재 ₩157,800</div>
                            <div class="arrow">➡️</div>
                            <div class="amount">목표 ₩100,000</div>
                        </div>
                        <div class="savings-effect">월 57,800원 절약</div>
                        <div class="solution-divider"></div>
                         <a href="#" class="solution-item">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="emoji-bg">🍱</div>
                                <div>
                                    <div style="font-size: 14px; font-weight: 500;">식비 관리</div>
                                    <div style="font-size: 12px; color: var(--muted-foreground);">주 1회 장보기 + 밀프렙 활용</div>
                                </div>
                            </div>
                            <span class="link-text">바로가기</span>
                        </a>
                    </div>
                </div>
                
                <div class="card ai-challenge-card">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px;">
                        <h2 class="card-title" style="margin: 0;">✨ AI 절약 챌린지</h2>
                        <button class="action-button btn-primary" style="width: auto; padding: 6px 12px; font-size: 13px;" onclick="generateChallenge()">새로운 챌린지 받기</button>
                    </div>
                    <div id="challenge-container" class="challenge-content">
                        <p style="font-size: 14px; color: var(--muted-foreground); text-align: center; margin-top: 20px;">버튼을 눌러 맞춤 챌린지를 받아보세요!</p>
                    </div>
                </div>

                 <div class="card long-term-goal">
                    <div class="card-header"><h2 class="card-title">🎯 장기 재무 목표</h2></div>
                    <div class="goal-item">
                        <h3>비상자금 3개월치 모으기</h3>
                        <p class="goal-reason">소득 중단, 질병 등 갑작스러운 위기 시 부채 없이 자산을 지키는 안전망입니다.</p>
                        <div class="race-track">
                            <div class="progress-line" style="width: 16%; background-color: #ffcc00;"></div>
                            <div class="tortoise" style="left: calc(16% - 12px);">🐢</div>
                            <div class="hare">🐇</div>
                        </div>
                        <div class="race-progress-text">155만원 / 941만원 (16%)</div>
                    </div>
                    <div class="goal-item">
                        <h3>월 저축률 30% 달성하기</h3>
                        <p class="goal-reason">자산 증식의 기반이 되는 종잣돈을 마련하고, 장기적인 재무 목표 달성을 앞당깁니다.</p>
                        <div class="race-track">
                            <div class="progress-line" style="width: 56%; background-color: var(--primary-color);"></div>
                            <div class="tortoise" style="left: calc(56% - 12px);">🐢</div>
                            <div class="hare">🐇</div>
                        </div>
                        <div class="race-progress-text">16.8% / 30% (56%)</div>
                    </div>
                </div>
            </div>

            <div id="tools" class="tab-content">
                <div class="card">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px;">
                         <h2 class="card-title" style="margin: 0;">✨ AI 맞춤 카드 추천</h2>
                         <button class="action-button btn-primary" style="width: auto; padding: 6px 12px; font-size: 13px;" onclick="generateRecommendations()">AI 추천 받기</button>
                    </div>
                    <div id="recommendation-container">
                         <p style="font-size: 14px; color: var(--muted-foreground); text-align: center; margin-top: 20px;">버튼을 눌러 소비 패턴에 맞는 카드를 추천받으세요!</p>
                    </div>
                </div>
            </div>
        </div>
        
        <nav class="bottom-nav">
            <a href="#" class="nav-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                <span>홈</span>
            </a>
            <a href="#" class="nav-item active">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="5" rx="2"></rect><line x1="2" x2="22" y1="10" y2="10"></line></svg>
                <span>AI 가계부</span>
            </a>
            <a href="#" class="nav-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                <span>AI 자산관리</span>
            </a>
            <a href="#" class="nav-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                <span>AI 재무설계</span>
            </a>
        </nav>
    </div>

    <script>
        let isSummaryGenerated = false;
        let isRecommendationGenerated = false;
        let audioContext;
        let currentSummaryText = "";

        // 탭 전환 로직
        function switchTab(event, tabName) {
            const tabTriggers = document.querySelectorAll('.tab-trigger');
            tabTriggers.forEach(trigger => trigger.classList.remove('active'));
            event.currentTarget.classList.add('active');

            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'savings' && !isSummaryGenerated) {
                generateSummary();
                isSummaryGenerated = true;
            }
            if (tabName === 'tools' && !isRecommendationGenerated) {
                // generateRecommendations(); // 탭 진입 시 자동 추천 원하면 활성화
                // isRecommendationGenerated = true;
            }
        }
        
        // --- Gemini API 호출 공통 함수 ---
        async function callGeminiAPI(payload) {
            const apiKey = ""; // API 키는 비워두세요.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-preview-0527:generateContent?key=${apiKey}`;
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API 요청 실패: ${response.status} ${response.statusText}`);
            }
            return response.json();
        }


        // Gemini API 종합 진단 생성 로직
        const summaryContainer = document.getElementById('ai-summary-container');
        
        async function generateSummary() {
            const userFinancialData = "이번 달 변동비 비율 50.7% (권장 30% 초과), 주요 지출 항목: 온라인쇼핑(49만원), 카페/간식(15만원), 월간 현금흐름: -49만원 적자";
            const prompt = `당신은 자산 관리 전문가 '손PB'입니다. 사용자의 이번 달 소비 데이터를 분석하고, 가장 중요한 문제점과 개선 방향을 짚어주는 종합 진단을 내려주십시오. 신뢰감을 주는 전문가의 톤을 유지하되, 모든 문장을 '~입니다', '~습니다'로 끝맺는 격식 있는 말투를 사용해주십시오. '분석해 보니', '살펴보니'와 같은 분석 과정을 드러내는 말이나, 사용자의 의지를 직접적으로 언급하는 표현은 빼고, 바로 핵심적인 진단 내용으로 들어가 주세요. 소비 목표를 달성하면 월 약 17만원을 절약할 수 있다는 점을 핵심 요약에 포함해주세요. 데이터: ${userFinancialData}. 결과는 다음 JSON 형식으로 주세요: {"title": "AI 소비 진단 요약", "summary": "2-3문장의 요약 분석 및 격려 메시지", "focus_point": "가장 핵심적인 조언 한 가지"}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                }
            };

            try {
                const result = await callGeminiAPI(payload);
                
                if (result.candidates && result.candidates.length > 0) {
                    const summaryData = JSON.parse(result.candidates[0].content.parts[0].text);
                    currentSummaryText = `${summaryData.summary} ${summaryData.focus_point}`;
                    
                    summaryContainer.innerHTML = `
                        <span>✨</span>
                        <div>
                            <div class="alert-title">
                                ${summaryData.title}
                                <button class="tts-button" onclick="playTTSSummary()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                </button>
                            </div>
                            <div>${summaryData.summary} <span style="font-weight: 500;">${summaryData.focus_point}</span></div>
                        </div>
                    `;
                } else {
                    throw new Error("API로부터 유효한 응답을 받지 못했습니다.");
                }

            } catch (error) {
                console.error("Gemini API 요약 생성 중 오류 발생:", error);
                summaryContainer.innerHTML = `
                    <span>⚠️</span>
                    <div>
                        <div class="alert-title">진단 실패</div>
                        <div>AI 분석 중 오류가 발생했어요. 잠시 후 다시 시도해 주세요.</div>
                    </div>
                `;
            }
        }

        // Gemini API 챌린지 생성 로직
        const challengeContainer = document.getElementById('challenge-container');
        
        async function generateChallenge() {
            challengeContainer.innerHTML = '<div class="loading-spinner">✨ AI가 맞춤 챌린지를 만들고 있어요...</div>';

            const userSpendingData = "인터넷쇼핑(33만원), 서비스구독(9만원), 카페/간식(15만원)";
            const prompt = `당신은 친절한 재무 관리 전문가입니다. 사용자의 주요 지출 내역은 '${userSpendingData}'입니다. 이 데이터를 바탕으로, 사용자가 재미있게 실천할 수 있는 1주일짜리 절약 챌린지를 한국어로 만들어 주세요. 결과는 반드시 다음 JSON 형식에 맞춰서 주세요: {"title": "챌린지 제목", "description": "챌린지에 대한 짧은 설명 (1-2문장)", "tips": ["실천 팁 1", "실천 팁 2", "실천 팁 3"]}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                }
            };
            
            try {
                const result = await callGeminiAPI(payload);
                
                if (result.candidates && result.candidates.length > 0) {
                    const challengeData = JSON.parse(result.candidates[0].content.parts[0].text);
                    let tipsHtml = challengeData.tips.map(tip => `<li>${tip}</li>`).join('');
                    challengeContainer.innerHTML = `
                        <div class="challenge-title">${challengeData.title}</div>
                        <p class="challenge-description">${challengeData.description}</p>
                        <ul class="challenge-tips">${tipsHtml}</ul>
                    `;
                } else {
                    throw new Error("API로부터 유효한 응답을 받지 못했습니다.");
                }

            } catch (error) {
                console.error("Gemini API 챌린지 생성 중 오류 발생:", error);
                challengeContainer.innerHTML = '<p style="font-size: 14px; color: var(--danger-color); text-align: center; margin-top: 20px;">챌린지를 만드는 데 실패했어요. 잠시 후 다시 시도해 주세요.</p>';
            }
        }

        // Gemini API 상품 추천 로직
        const recommendationContainer = document.getElementById('recommendation-container');

        async function generateRecommendations() {
            recommendationContainer.innerHTML = '<div class="loading-spinner" style="height: 200px;">✨ AI가 맞춤 상품을 찾고 있어요...</div>';
            
            const userSpendingData = "주요 소비처: 온라인 쇼핑(특히 쿠팡), 카페/간식. 서비스 구독료도 지출 중.";
            const prompt = `당신은 금융 상품 추천 전문가입니다. 사용자의 소비 패턴은 '${userSpendingData}'입니다. 이 사용자에게 가장 유리한 신용카드 2개를 추천해주세요. 각 카드의 핵심 혜택과 추천 이유를 포함해야 합니다. 쿠팡 지출과 관련하세는 신한카드 Discount Plan+를 추천하세요. 결과는 반드시 다음 JSON 형식의 배열로 주세요: [{"name": "카드 이름", "benefit": "핵심 혜택 요약", "reason": "이 사용자에게 추천하는 이유", "gradient": "CSS linear-gradient 값"}, ... ]`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                }
            };

            try {
                const result = await callGeminiAPI(payload);
                if (result.candidates && result.candidates.length > 0) {
                    const recommendations = JSON.parse(result.candidates[0].content.parts[0].text);
                    let recsHtml = '';
                    recommendations.forEach(rec => {
                        recsHtml += `
                            <div class="product-card" style="margin-top: 16px;">
                                <div class="card-design" style="background: ${rec.gradient};">
                                    <div class="brand">SonPB's Pick</div>
                                    <div class="name">${rec.name}</div>
                                </div>
                                <p style="margin-top: 12px; font-size: 14px; font-weight: 700;">${rec.benefit}</p>
                                <p style="margin-top: 4px; font-size: 13px; color: var(--muted-foreground);">${rec.reason}</p>
                            </div>
                        `;
                    });
                    recommendationContainer.innerHTML = recsHtml;
                } else {
                     throw new Error("API로부터 유효한 응답을 받지 못했습니다.");
                }
            } catch (error) {
                 console.error("Gemini API 추천 생성 중 오류 발생:", error);
                recommendationContainer.innerHTML = '<p style="font-size: 14px; color: var(--danger-color); text-align: center; margin-top: 20px;">추천 상품을 불러오는 데 실패했어요. 잠시 후 다시 시도해 주세요.</p>';
            }
        }

        // --- Gemini TTS 관련 함수 (수정 없음) ---
        // (기존 TTS 함수 코드는 여기에 그대로 유지됩니다)

    </script>
</body>
</html>