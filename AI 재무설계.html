<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 재무설계 대시보드 - 손PB</title>
    <!-- ECharts (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <style>
        /* 기본 스타일 및 폰트 설정 */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        
        :root {
            --primary-color: #007aff;
            --danger-color: #ff3b30;
            --warning-color: #ff9500;
            --success-color: #34c759;
            --muted-foreground: #8a8a8e;
            --card-border: #e5e5ea;
            --background: #f0f2f5;
        }

        body {
            background-color: var(--background);
            font-family: 'Noto Sans KR', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #1c1c1e;
        }

        /* 스마트폰 프레임 */
        .phone-container {
            width: 375px;
            height: 812px;
            background-color: #ffffff;
            border-radius: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* 메인 콘텐츠 영역 */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            padding-bottom: 80px; /* 하단 네비게이션 공간 확보 */
        }
        
        .content::-webkit-scrollbar {
            display: none;
        }

        /* 공통 카드 스타일 */
        .card {
            background-color: #ffffff;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--card-border);
        }

        .card-header {
            padding-bottom: 12px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .card-desc {
            font-size: 13px;
            color: var(--muted-foreground);
            margin-top: 4px;
        }

        /* KPI 요약 카드 */
        .kpi-card .kpi-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            text-align: center;
        }
        .kpi-card .kpi-item {
            padding: 12px 4px; /* 좌우 패딩 감소 */
            border-radius: 12px;
            display: flex; /* Flexbox 추가 */
            flex-direction: column; /* 세로 정렬 */
            justify-content: center; /* 수직 중앙 정렬 */
            min-height: 80px; /* 최소 높이 지정 */
        }
        .kpi-card .kpi-item .kpi-label {
            font-size: 12px;
            color: var(--muted-foreground);
            margin-bottom: 4px;
            line-height: 1.3; /* 줄간격 조정 */
        }
        .kpi-card .kpi-item .kpi-value {
            font-size: 18px;
            font-weight: 700;
        }

        /* 목표 카드 */
        .goal-card {
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--card-border);
            margin-bottom: 12px;
        }
        .goal-card:last-child {
            margin-bottom: 0;
        }
        .goal-card .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .goal-card .goal-name {
            font-weight: 700;
            font-size: 15px;
        }
        .goal-card .goal-badge {
            font-size: 11px;
            font-weight: 500;
            padding: 3px 8px;
            border-radius: 9999px;
            background-color: #eef2ff;
            color: #4338ca;
        }
        .goal-card .goal-rationale {
            font-size: 12px;
            color: var(--muted-foreground);
            margin-bottom: 12px;
            line-height: 1.5;
        }
        .goal-card .goal-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            font-size: 13px;
        }
        .goal-card .detail-label {
            color: var(--muted-foreground);
            font-size: 12px;
        }
        .goal-card .detail-value {
            font-weight: 500;
        }
        .goal-card .detail-value.highlight {
            font-weight: 700;
            color: var(--primary-color);
        }

        /* 포트폴리오 파이 차트 */
        .pie-legend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            margin-bottom: 8px;
        }
        .pie-legend-item .legend-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .pie-legend-item .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .pie-legend-item .legend-value {
            font-weight: 500;
        }

        /* AI 브리핑 카드 */
        .ai-briefing-card {
            background: linear-gradient(135deg, #4338ca, #007aff);
            color: white;
        }
        .ai-briefing-card .card-title {
            color: white;
        }
        .ai-briefing-card .card-desc {
            color: rgba(255, 255, 255, 0.7);
        }
        .ai-briefing-card #briefing {
            font-size: 14px;
            line-height: 1.7;
            min-height: 150px;
        }
        .ai-briefing-card .refresh-button {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
        }
        
        /* 분석 차트 탭 & 서브 탭 */
        .analysis-tabs, .sub-tabs {
            display: flex;
            gap: 4px;
            overflow-x: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .analysis-tabs::-webkit-scrollbar, .sub-tabs::-webkit-scrollbar {
            display: none;
        }
        .analysis-tabs {
            border-bottom: 1px solid var(--card-border);
            margin-bottom: 16px;
        }
        .sub-tabs {
            padding-bottom: 12px;
        }
        .analysis-tab {
            padding: 8px 4px;
            font-size: 14px;
            font-weight: 500;
            color: var(--muted-foreground);
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
        }
        .analysis-tab.active {
            color: var(--primary-color);
            font-weight: 700;
            border-bottom-color: var(--primary-color);
        }
        .analysis-content {
            display: none;
        }
        .analysis-content.active {
            display: block;
        }
        .sub-tab {
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 500;
            border-radius: 9999px;
            background-color: #f3f4f6;
            color: #4b5563;
            border: none;
            cursor: pointer;
            white-space: nowrap;
        }
        .sub-tab.active {
            background-color: #eef2ff;
            color: #4338ca;
            font-weight: 700;
        }


        /* 하단 네비게이션 바 */
        .bottom-nav {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background-color: #ffffff;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid var(--card-border);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--muted-foreground);
            font-size: 11px;
            font-weight: 500;
            text-decoration: none;
        }
        .nav-item.active {
            color: var(--primary-color);
        }
        .nav-item svg {
            width: 24px;
            height: 24px;
        }
    </style>
</head>
<body>
    <div class="phone-container">
        <div class="content">
            <!-- 페이지 타이틀 -->
            <div style="padding: 0 4px 16px;">
                <h1 style="font-size: 22px; font-weight: 800;">'넉넉한 윤리쌤'님<br>AI 재무설계</h1>
                <p style="font-size: 12px; color: var(--muted-foreground); margin-top: 4px;">분석 기준일: <span id="asof"></span></p>
            </div>

            <!-- KPIs -->
            <div class="card kpi-card">
                <div class="card-header">
                    <h2 class="card-title">📈 손PB 재무설계 요약</h2>
                    <p class="card-desc">AI가 분석한 월 투자 계획입니다.</p>
                </div>
                <div class="card-content">
                    <div class="kpi-grid">
                        <div class="kpi-item" style="background-color: #f0f5ff;">
                            <div class="kpi-label">총 월 투자금</div>
                            <div id="kpi-monthly" class="kpi-value" style="color: #4338ca;">-</div>
                        </div>
                        <div class="kpi-item" style="background-color: #f0fdf4;">
                            <div class="kpi-label">설정된 목표</div>
                            <div id="kpi-goalcount" class="kpi-value" style="color: #15803d;">-</div>
                        </div>
                        <div class="kpi-item" style="background-color: #fffbeb;">
                            <div class="kpi-label">최장기 목표</div>
                            <div id="kpi-maxhorizon" class="kpi-value" style="color: #b45309;">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Goals -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">🎯 손PB 추천 재무목표</h2>
                    <p class="card-desc">재무설계 전문가 손PB가 맞춤형 재무목표를 도출했어요.</p>
                </div>
                <div id="goal-grid" class="card-content" style="padding-top: 0;"></div>
            </div>
            
            <!-- 목표 달성 분석 (시뮬레이션 & 백테스팅) -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">🔬 목표 달성 분석</h2>
                    <p class="card-desc">AI가 예측한 미래 자산과 과거 성과입니다.</p>
                </div>
                <div class="card-content">
                    <div class="analysis-tabs">
                        <button id="show-sim" class="analysis-tab active">시뮬레이션</button>
                        <button id="show-bt" class="analysis-tab">백테스팅</button>
                    </div>
                    <div id="sim-content" class="analysis-content active">
                        <div id="sim-tabs" class="sub-tabs"></div>
                        <div id="sim-chart" style="height: 250px; margin-top: 16px;"></div>
                    </div>
                    <div id="bt-content" class="analysis-content">
                        <div id="bt-tabs" class="sub-tabs"></div>
                        <div id="bt-chart" style="height: 250px; margin-top: 16px;"></div>
                    </div>
                </div>
            </div>


            <!-- Portfolio Pie -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">📊 추천 월 투자 포트폴리오</h2>
                    <p class="card-desc">맞춤 재무목표 달성을 위한 월 투자 포트폴리오입니다</p>
                </div>
                <div class="card-content">
                    <div id="portfolio-tabs" class="sub-tabs"></div>
                    <div id="pie-chart" style="height: 200px; margin-top: 16px;"></div>
                    <div id="pie-legend" style="margin-top: 16px;"></div>
                </div>
            </div>

            <!-- AI Briefing -->
            <div class="card ai-briefing-card">
                <div class="card-header" style="border: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h2 class="card-title">✨ 손PB AI 종합 브리핑</h2>
                            <p class="card-desc">버튼을 눌러 요약을 생성하세요.</p>
                        </div>
                        <button id="btn-brief" class="refresh-button">🔄</button>
                    </div>
                </div>
                <div class="card-content">
                    <div id="briefing">우측 상단 버튼을 눌러 브리핑을 생성하세요.</div>
                </div>
            </div>
        </div>
        
        <!-- 하단 네비게이션 바 -->
        <nav class="bottom-nav">
            <a href="#" class="nav-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                <span>홈</span>
            </a>
            <a href="#" class="nav-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="5" rx="2"></rect><line x1="2" x2="22" y1="10" y2="10"></line></svg>
                <span>AI 가계부</span>
            </a>
            <a href="#" class="nav-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                <span>AI 자산관리</span>
            </a>
            <a href="#" class="nav-item active">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                <span>AI 재무설계</span>
            </a>
        </nav>
    </div>

    <script>
        // ====== Raw Data ======
        const customerDataYoonRaw = {
            lastUpdated: "2025-08-27T22:00:20.690397",
            customerInfo: { age: 30 },
            goals: [
                { id: "G0", name: "은퇴 자금 마련(약 6억원)", horizonMonths: 420, targetKRW: 496529103, monthlyInvestKRW: 66519, expectedFinalKRW: 608906904, rationale: "안정적인 노후 생활을 위한 장기 투자 플랜의 핵심" },
                { id: "G1", name: "단기 저축 목표", horizonMonths: 60, targetKRW: 100000000, monthlyInvestKRW: 1169229, expectedFinalKRW: 102463095, rationale: "5년 내 목돈 마련을 위한 가장 우선순위가 높은 단기 집중 목표입니다." },
                { id: "G2", name: "여행 자금", horizonMonths: 12, targetKRW: 20000000, monthlyInvestKRW: 125855, expectedFinalKRW: 1594986, rationale: "삶의 질 향상을 위한 연 단위의 단기 재충전 목표입니다." },
                { id: "G5", name: "청년 주택드림 청약", horizonMonths: null, targetKRW: null, monthlyInvestKRW: 100000, expectedFinalKRW: null, rationale: "내 집 마련의 초석이 되는 정부 지원 정책 활용 극대화 목표입니다." },
                { id: "G6", name: "현금성 자산 (유동성)", horizonMonths: null, targetKRW: null, monthlyInvestKRW: 151289, expectedFinalKRW: null, rationale: "예상치 못한 지출에 대비하고 투자 기회를 포착하기 위한 비상금입니다." }
            ],
            portfolio_amount: [
                { "재무 목표": "은퇴 자금 마련", "KODEX 미국나스닥100": 26300, "TIGER KRX금현물": 32500, "TIGER 우량회사채액티브": 7800, "청년도약계좌": 0, "청년 주택드림 청약통장": 0, "현금": 0 },
                { "재무 목표": "단기 저축 목표", "KODEX 미국나스닥100": 576600, "TIGER KRX금현물": 335400, "TIGER 우량회사채액티브": 0, "청년도약계좌": 257000, "청년 주택드림 청약통장": 0, "현금": 0 },
                { "재무 목표": "여행 자금", "KODEX 미국나스닥100": 37700, "TIGER KRX금현물": 0, "TIGER 우량회사채액티브": 0, "청년도약계좌": 88000, "청년 주택드림 청약통장": 0, "현금": 0 },
                { "재무 목표": "청년 주택드림 청약통장", "KODEX 미국나스닥100": 0, "TIGER KRX금현물": 0, "TIGER 우량회사채액티브": 0, "청년도약계좌": 0, "청년 주택드림 청약통장": 100000, "현금": 0 },
                { "재무 목표": "현금", "KODEX 미국나스닥100": 0, "TIGER KRX금현물": 0, "TIGER 우량회사채액티브": 0, "청년도약계좌": 0, "청년 주택드림 청약통장": 0, "현금": 151289 },
                { "재무 목표": "종합", "KODEX 미국나스닥100": 640600, "TIGER KRX금현물": 367900, "TIGER 우량회사채액티브": 7800, "청년도약계좌": 345000, "청년 주택드림 청약통장": 100000, "현금": 151289 }
            ],
            portfolio_perc: [
                { "재무 목표": "은퇴 자금 마련", "KODEX 미국나스닥100": 39.5, "TIGER KRX금현물": 48.8, "TIGER 우량회사채액티브": 11.7, "청년도약계좌": 0.0, "청년 주택드림 청약통장": 0.0, "현금": 0.0 },
                { "재무 목표": "단기 저축 목표", "KODEX 미국나스닥100": 49.3, "TIGER KRX금현물": 28.7, "TIGER 우량회사채액티브": 0.0, "청년도약계좌": 22.0, "청년 주택드림 청약통장": 0.0, "현금": 0.0 },
                { "재무 목표": "여행 자금", "KODEX 미국나스닥100": 30.0, "TIGER KRX금현물": 0.0, "TIGER 우량회사채액티브": 0.0, "청년도약계좌": 70.0, "청년 주택드림 청약통장": 0.0, "현금": 0.0 },
                { "재무 목표": "청년 주택드림 청약통장", "KODEX 미국나스닥100": 0.0, "TIGER KRX금현물": 0.0, "TIGER 우량회사채액티브": 0.0, "청년도약계좌": 0.0, "청년 주택드림 청약통장": 100.0, "현금": 0.0 },
                { "재무 목표": "현금", "KODEX 미국나스닥100": 0.0, "TIGER KRX금현물": 0.0, "TIGER 우량회사채액티브": 0.0, "청년도약계좌": 0.0, "청년 주택드림 청약통장": 0.0, "현금": 100.0 },
                { "재무 목표": "종합", "KODEX 미국나스닥100": 39.7, "TIGER KRX금현물": 22.8, "TIGER 우량회사채액티브": 0.5, "청년도약계좌": 21.4, "청년 주택드림 청약통장": 6.2, "현금": 9.4 }
            ],
            backtestResults: {
                G0: {
                    period: "2016-2025", metrics: { CAGR: 0.131, maxDD: -0.183, sharpe: 1.15 },
                    equityCurve: [ { year: 2016, "나의 포트폴리오": 839298, "S&P 500": 849766 }, { year: 2017, "나의 포트폴리오": 1862351, "S&P 500": 1881506 }, { year: 2018, "나의 포트폴리오": 2954534, "S&P 500": 2495084 }, { year: 2019, "나의 포트폴리오": 4718677, "S&P 500": 4094117 }, { year: 2020, "나의 포트폴리오": 5983567, "S&P 500": 5698885 }, { year: 2021, "나의 포트폴리오": 7624854, "S&P 500": 8122749 }, { year: 2022, "나의 포트폴리오": 8510854, "S&P 500": 7296111 }, { year: 2023, "나의 포트폴리오": 10693583, "S&P 500": 9944178 }, { year: 2024, "나의 포트폴리오": 13335888, "S&P 500": 13121304 }, { year: 2025, "나의 포트폴리오": 15045528, "S&P 500": 14637088 } ]
                },
                G1: {
                    period: "2016-2020", metrics: { CAGR: 0.082, maxDD: -0.11, sharpe: 0.85 },
                    equityCurve: [ { year: 2016, "나의 포트폴리오": 14752597, "S&P 500": 14936597 }, { year: 2017, "나의 포트폴리오": 32638167, "S&P 500": 33071802 }, { year: 2018, "나의 포트폴리오": 50826714, "S&P 500": 43856840 }, { year: 2019, "나의 포트폴리오": 74556252, "S&P 500": 71963525 }, { year: 2020, "나의 포트폴리오": 92075737, "S&P 500": 100171007 } ]
                }
            }
        };

        // ====== Utilities ======
        const krw = (n) => new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW', maximumFractionDigits: 0 }).format(Number.isFinite(n) ? n : 0);
        const kFormat = (v) => v >= 100000000 ? `${(v/100000000).toFixed(1).replace(/\.0$/, '')}억` : (v >= 10000 ? `${Math.round(v/10000)}만` : `${v}`);
        const pct = (x, d = 1) => `${(((Number.isFinite(x)?x:0) * 100)).toFixed(d)}%`;

        function buildAssetsFromTables(amount, perc, goalName) {
            try {
                const sumRow = (amount || []).find(r => r["재무 목표"] === goalName);
                if (!sumRow) return [];
                const assets = Object.keys(sumRow).filter(k => k !== '재무 목표' && sumRow[k] > 0);
                const percRow = (perc || []).find(r => r["재무 목표"] === goalName) || {};
                return assets.map(symbol => ({ 
                    symbol, 
                    monthlyKRW: Number(sumRow[symbol] || 0), 
                    weight: Number(percRow[symbol] || 0) / 100 
                }));
            } catch(e) { console.warn(e); return []; }
        }

        function ensureDataShape(raw) {
            const d = raw && typeof raw === 'object' ? raw : {};
            const totalAssets = buildAssetsFromTables(d.portfolio_amount, d.portfolio_perc, "종합");
            const monthlyBudgetKRW = totalAssets.reduce((s, a) => s + a.monthlyKRW, 0);
            return {
                lastUpdated: d.lastUpdated || new Date().toISOString(),
                customerInfo: d.customerInfo || { age: 30 },
                goals: Array.isArray(d.goals) ? d.goals : [],
                portfolio: { 
                    monthlyBudgetKRW, 
                    assets: totalAssets,
                    byGoal: (d.portfolio_amount || []).reduce((acc, row) => {
                        const goalName = row["재무 목표"];
                        if (goalName !== "종합") {
                           acc[goalName] = buildAssetsFromTables(d.portfolio_amount, d.portfolio_perc, goalName);
                        }
                        return acc;
                    }, {})
                },
                backtestResults: d.backtestResults || {}
            };
        }

        // ====== State ======
        const state = ensureDataShape(customerDataYoonRaw);
        const palette = ['#4f46e5', '#10b981', '#3b82f6', '#8b5cf6', '#a8a29e', '#f59e0b', '#ef4444', '#06b6d4'];
        
        // ====== Gemini API Function ======
        async function callGeminiAPI(prompt) {
            const apiKey = ""; // API 키는 비워두세요.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API 요청 실패: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini API 호출 중 오류 발생:", error);
                return "브리핑 생성 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.";
            }
        }


        // ====== DOM Ready ======
        document.addEventListener('DOMContentLoaded', () => {
            // DOM refs
            const asof = document.getElementById('asof');
            const kpiMonthly = document.getElementById('kpi-monthly');
            const kpiGoalCount = document.getElementById('kpi-goalcount');
            const kpiMaxHorizon = document.getElementById('kpi-maxhorizon');
            const goalGrid = document.getElementById('goal-grid');
            const pieLegend = document.getElementById('pie-legend');
            const pieChartEl = document.getElementById('pie-chart');
            const btnBrief = document.getElementById('btn-brief');
            const briefing = document.getElementById('briefing');
            const simChartEl = document.getElementById('sim-chart');
            const btChartEl = document.getElementById('bt-chart');
            const portfolioTabs = document.getElementById('portfolio-tabs');

            let pieChart, simChart, btChart;

            // Init Basics
            asof.textContent = new Date(state.lastUpdated).toLocaleDateString('ko-KR');
            kpiMonthly.textContent = krw(state.portfolio.monthlyBudgetKRW);
            kpiGoalCount.textContent = `${state.goals.length}개`;
            const maxMonths = Math.max(...state.goals.map(g => g.horizonMonths || 0));
            kpiMaxHorizon.textContent = `${maxMonths/12}년`;

            // Goal Cards
            state.goals.forEach(g => {
                const card = document.createElement('div');
                card.className = 'goal-card';
                card.innerHTML = `
                    <div class="goal-header">
                        <h3 class="goal-name">${g.name}</h3>
                        ${g.targetKRW ? `<span class="goal-badge">P${g.id.replace('G','')}</span>` : ''}
                    </div>
                    <p class="goal-rationale">${g.rationale || ''}</p>
                    <div class="goal-details">
                        <div>
                            <p class="detail-label">월 투자금</p>
                            <p class="detail-value">${krw(g.monthlyInvestKRW)}</p>
                        </div>
                        <div>
                            <p class="detail-label">목표 기간</p>
                            <p class="detail-value">${g.horizonMonths ? (g.horizonMonths/12 + ' 년') : 'N/A'}</p>
                        </div>
                        <div>
                            <p class="detail-label">최종 예상액</p>
                            <p class="detail-value highlight">${g.expectedFinalKRW ? krw(g.expectedFinalKRW) : 'N/A'}</p>
                        </div>
                    </div>`;
                goalGrid.appendChild(card);
            });

            // Portfolio Pie Chart Logic
            if (pieChartEl) {
                pieChart = echarts.init(pieChartEl);
                const portfolioTabDefs = [
                    { id: '종합', label: '종합' },
                    { id: '은퇴 자금 마련', label: '은퇴 자금' },
                    { id: '단기 저축 목표', label: '단기 저축' },
                    { id: '여행 자금', label: '여행 자금' }
                ];
                let portfolioActive = '종합';

                function renderPortfolioTabs() {
                    portfolioTabs.innerHTML = '';
                    portfolioTabDefs.forEach(def => {
                        const btn = document.createElement('button');
                        btn.className = `sub-tab ${portfolioActive === def.id ? 'active' : ''}`;
                        btn.textContent = def.label;
                        btn.addEventListener('click', () => {
                            portfolioActive = def.id;
                            drawPieChart();
                            renderPortfolioTabs();
                        });
                        portfolioTabs.appendChild(btn);
                    });
                }

                function drawPieChart() {
                    const assets = portfolioActive === '종합' ? state.portfolio.assets : state.portfolio.byGoal[portfolioActive] || [];
                    const pieData = assets.map((a, i) => ({ 
                        value: a.monthlyKRW, 
                        name: a.symbol, 
                        itemStyle: { color: palette[i % palette.length] }
                    }));
                    
                    pieChart.setOption({
                        tooltip: { trigger: 'item', formatter: ({name, value, percent}) => `${name}<br/>${krw(value)} (${percent}%)` },
                        series: [{
                            name: '포트폴리오', type: 'pie', radius: ['50%','75%'], avoidLabelOverlap: true, padAngle: 3,
                            label: { show: false }, labelLine: { show: false }, data: pieData
                        }]
                    }, true);

                    const totalForLegend = assets.reduce((sum, asset) => sum + asset.monthlyKRW, 0);
                    pieLegend.innerHTML = assets.map((a, i) => {
                        const weight = totalForLegend > 0 ? a.monthlyKRW / totalForLegend : 0;
                        return `
                        <div class="pie-legend-item">
                            <div class="legend-info">
                                <span class="legend-dot" style="background:${palette[i % palette.length]}"></span>
                                <span>${a.symbol}</span>
                            </div>
                            <div class="legend-value">${krw(a.monthlyKRW)} <span>(${pct(weight)})</span></div>
                        </div>`
                    }).join('');
                }
                
                renderPortfolioTabs();
                drawPieChart();
            }


            // AI Briefing
            btnBrief.addEventListener('click', async () => {
                btnBrief.disabled = true; 
                briefing.textContent = '✨ AI가 브리핑을 준비하고 있습니다...';
                
                const goalsSummary = state.goals.map(g => `- ${g.name} (기간: ${g.horizonMonths ? g.horizonMonths/12 + '년' : '지속'}, 월 ${krw(g.monthlyInvestKRW)})`).join('\n');
                const portfolioSummary = state.portfolio.assets.map(a => `- ${a.symbol}: ${pct(a.weight)}`).join('\n');

                const prompt = `당신은 전문 금융 어드바이저 '손PB'입니다. 다음 고객 데이터는 고객의 현재 자산이 아닌, 우리가 고객의 재무 목표 달성을 위해 추천하는 '추천 포트폴리오'입니다. 이 추천 포트폴리오가 왜 고객에게 적합한지 친절하고 이해하기 쉽게 설명하는 종합 브리핑을 작성해주세요. 결과는 HTML 형식으로, 각 섹션 제목은 <strong> 태그로 감싸주세요.

### 고객 데이터
- **총 월 투자금**: ${krw(state.portfolio.monthlyBudgetKRW)}
- **재무 목표**:
${goalsSummary}
- **추천 월 투자 포트폴리오 (종합)**:
${portfolioSummary}

### 브리핑 내용
1.  **요약**: 이 포트폴리오의 핵심 전략을 한두 문장으로 요약해주세요. (예: 안정적인 정부 지원 상품과 장기 성장 자산을 결합하여...)
2.  **목표와 포트폴리오 연결**: 각 재무 목표 달성을 위해 포트폴리오의 어떤 자산이 어떻게 기여하는지 설명해주세요. (예: '은퇴 자금 마련'을 위해 'KODEX 미국나스닥100'에, '단기 저축 목표'를 위해 '청년도약계좌'에 투자합니다.)
3.  **제언**: 이 포트폴리오를 꾸준히 유지했을 때 기대할 수 있는 긍정적인 미래에 대해 언급하며 격려해주세요.`;

                const result = await callGeminiAPI(prompt);
                briefing.innerHTML = result;
                btnBrief.disabled = false;
            });
            
            // --- Analysis Charts ---
            simChart = echarts.init(simChartEl);
            btChart = echarts.init(btChartEl);
            
            // Main Tabs
            document.getElementById('show-sim').addEventListener('click', (e) => {
                document.getElementById('show-bt').classList.remove('active');
                e.target.classList.add('active');
                document.getElementById('bt-content').classList.remove('active');
                document.getElementById('sim-content').classList.add('active');
                simChart.resize();
            });
            document.getElementById('show-bt').addEventListener('click', (e) => {
                document.getElementById('show-sim').classList.remove('active');
                e.target.classList.add('active');
                document.getElementById('sim-content').classList.remove('active');
                document.getElementById('bt-content').classList.add('active');
                btChart.resize();
            });

            // Simulation Logic
            const { seriesAll, seriesMap } = buildSimulationSeries();
            const simTabs = document.getElementById('sim-tabs');
            const simTabDefs = [{ id: 'all', label: '종합' }, ...state.goals.filter(g=>g.horizonMonths).map(g => ({ id: g.id, label: g.name }))];
            let simActive = 'all';

            function renderSimTabs() {
                simTabs.innerHTML = '';
                simTabDefs.forEach(def => {
                    const btn = document.createElement('button');
                    btn.className = `sub-tab ${simActive===def.id ? 'active' : ''}`;
                    btn.textContent = def.label;
                    btn.addEventListener('click', () => { simActive = def.id; drawSim(); renderSimTabs(); });
                    simTabs.appendChild(btn);
                });
            }

            function drawSim() {
                const option = {
                    grid: { left: 50, right: 20, top: 20, bottom: 30 },
                    xAxis: { 
                        type: 'value', 
                        min: state.customerInfo.age,
                        axisLabel: { formatter: val => `${Math.floor(val)}세` } 
                    },
                    yAxis: { 
                        type: 'value', 
                        axisLabel: { formatter: kFormat } 
                    },
                    tooltip: { trigger: 'axis', valueFormatter: v => krw(v) }
                };
                if (simActive === 'all') {
                    option.series = [{ name: '총 자산', type: 'line', areaStyle: {}, showSymbol: false, itemStyle: { color: '#007aff' }, data: seriesAll }];
                } else {
                    const data = seriesMap[simActive] || [];
                    option.series = [
                        { name: '예상 자산', type: 'line', areaStyle: {}, showSymbol: false, itemStyle: { color: '#007aff' }, data: data.map(([age, v]) => [age, v]) },
                        { name: '목표 금액', type: 'line', showSymbol: false, itemStyle: { color: '#a8a29e' }, lineStyle: { type: 'dashed' }, data: data.map(([age, , t]) => [age, t]) }
                    ];
                }
                simChart.setOption(option, true);
            }
            
            function buildSimulationSeries() {
                const goals = state.goals;
                const cagr = 0.07;
                const mRate = Math.pow(1 + cagr, 1/12) - 1;
                const finite = goals.filter(g => g.horizonMonths);
                const maxH = finite.length ? Math.max(...finite.map(g => g.horizonMonths)) : 0;
                const seriesAll = [];
                const seriesMap = {};
                const values = {};
                goals.forEach(g => { if (g.horizonMonths) { seriesMap[g.id] = []; values[g.id] = 0; } });
                
                let total = 0;
                for (let m=1; m<=maxH; m++) {
                    let monthlyInvestTotal = 0;
                    const age = state.customerInfo.age + m/12;
                    goals.forEach(g => {
                        if (g.horizonMonths && m <= g.horizonMonths) {
                            values[g.id] = values[g.id] * (1+mRate) + g.monthlyInvestKRW;
                            seriesMap[g.id].push([Number(age.toFixed(2)), values[g.id], g.targetKRW]);
                            monthlyInvestTotal += g.monthlyInvestKRW;
                        }
                    });
                    total = total * (1+mRate) + monthlyInvestTotal;
                    seriesAll.push([Number(age.toFixed(2)), total]);
                }
                return { seriesAll, seriesMap };
            }

            renderSimTabs();
            drawSim();

            // Backtest Logic
            const btTabs = document.getElementById('bt-tabs');
            const btDefs = Object.keys(state.backtestResults).map(k => ({ id: k, label: (state.goals.find(g=>g.id===k)?.name) || k }));
            let btActive = btDefs[0]?.id || 'G0';

            function renderBtTabs() {
                btTabs.innerHTML = '';
                btDefs.forEach(def => {
                    const btn = document.createElement('button');
                    btn.className = `sub-tab ${btActive===def.id ? 'active' : ''}`;
                    btn.textContent = def.label;
                    btn.addEventListener('click', () => { btActive = def.id; drawBt(); renderBtTabs(); });
                    btTabs.appendChild(btn);
                });
            }

            function drawBt() {
                const res = state.backtestResults[btActive];
                if (!res) return;
                const curve = res.equityCurve;
                const mkSeries = (key, color, dash) => ({
                    name: key, type: 'line', data: curve.map(d => [d.year, d[key]]), showSymbol: false,
                    lineStyle: { color, type: dash || 'solid', width: key==='나의 포트폴리오'? 2.5 : 1.5 },
                });

                btChart.setOption({
                    legend: { top: 0, textStyle: { fontSize: 11 } },
                    grid: { left: 50, right: 20, top: 30, bottom: 30 },
                    xAxis: { type: 'value', axisLabel: { formatter: v => v } },
                    yAxis: { type: 'value', axisLabel: { formatter: kFormat } },
                    tooltip: { trigger: 'axis', valueFormatter: v => krw(v) },
                    series: [
                        mkSeries('나의 포트폴리오', '#007aff', 'solid'),
                        mkSeries('S&P 500', '#a8a29e', 'dashed'),
                    ]
                });
            }

            renderBtTabs();
            drawBt();
            
            window.addEventListener('resize', () => {
                if(pieChart) pieChart.resize();
                if(simChart) simChart.resize();
                if(btChart) btChart.resize();
            });
        });
    </script>
</body>
</html>
