<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ì¬ë¬´ì„¤ê³„ ëŒ€ì‹œë³´ë“œ - ì†PB</title>
    <!-- ECharts (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë° í°íŠ¸ ì„¤ì • */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        
        :root {
            --primary-color: #007aff;
            --danger-color: #ff3b30;
            --warning-color: #ff9500;
            --success-color: #34c759;
            --muted-foreground: #8a8a8e;
            --card-border: #e5e5ea;
            --background: #f0f2f5;
        }

        body {
            background-color: var(--background);
            font-family: 'Noto Sans KR', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #1c1c1e;
        }

        /* ìŠ¤ë§ˆíŠ¸í° í”„ë ˆì„ */
        .phone-container {
            width: 375px;
            height: 812px;
            background-color: #ffffff;
            border-radius: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            padding-bottom: 80px; /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ê³µê°„ í™•ë³´ */
        }
        
        .content::-webkit-scrollbar {
            display: none;
        }

        /* ê³µí†µ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card {
            background-color: #ffffff;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--card-border);
        }

        .card-header {
            padding-bottom: 12px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .card-desc {
            font-size: 13px;
            color: var(--muted-foreground);
            margin-top: 4px;
        }

        /* KPI ìš”ì•½ ì¹´ë“œ */
        .kpi-card .kpi-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            text-align: center;
        }
        .kpi-card .kpi-item {
            padding: 12px 4px; /* ì¢Œìš° íŒ¨ë”© ê°ì†Œ */
            border-radius: 12px;
            display: flex; /* Flexbox ì¶”ê°€ */
            flex-direction: column; /* ì„¸ë¡œ ì •ë ¬ */
            justify-content: center; /* ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬ */
            min-height: 80px; /* ìµœì†Œ ë†’ì´ ì§€ì • */
        }
        .kpi-card .kpi-item .kpi-label {
            font-size: 12px;
            color: var(--muted-foreground);
            margin-bottom: 4px;
            line-height: 1.3; /* ì¤„ê°„ê²© ì¡°ì • */
        }
        .kpi-card .kpi-item .kpi-value {
            font-size: 18px;
            font-weight: 700;
        }

        /* ëª©í‘œ ì¹´ë“œ */
        .goal-card {
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--card-border);
            margin-bottom: 12px;
        }
        .goal-card:last-child {
            margin-bottom: 0;
        }
        .goal-card .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .goal-card .goal-name {
            font-weight: 700;
            font-size: 15px;
        }
        .goal-card .goal-badge {
            font-size: 11px;
            font-weight: 500;
            padding: 3px 8px;
            border-radius: 9999px;
            background-color: #eef2ff;
            color: #4338ca;
        }
        .goal-card .goal-rationale {
            font-size: 12px;
            color: var(--muted-foreground);
            margin-bottom: 12px;
            line-height: 1.5;
        }
        .goal-card .goal-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            font-size: 13px;
        }
        .goal-card .detail-label {
            color: var(--muted-foreground);
            font-size: 12px;
        }
        .goal-card .detail-value {
            font-weight: 500;
        }
        .goal-card .detail-value.highlight {
            font-weight: 700;
            color: var(--primary-color);
        }

        /* í¬íŠ¸í´ë¦¬ì˜¤ íŒŒì´ ì°¨íŠ¸ */
        .pie-legend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            margin-bottom: 8px;
        }
        .pie-legend-item .legend-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .pie-legend-item .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .pie-legend-item .legend-value {
            font-weight: 500;
        }

        /* AI ë¸Œë¦¬í•‘ ì¹´ë“œ */
        .ai-briefing-card {
            background: linear-gradient(135deg, #4338ca, #007aff);
            color: white;
        }
        .ai-briefing-card .card-title {
            color: white;
        }
        .ai-briefing-card .card-desc {
            color: rgba(255, 255, 255, 0.7);
        }
        .ai-briefing-card #briefing {
            font-size: 14px;
            line-height: 1.7;
            min-height: 150px;
        }
        .ai-briefing-card .refresh-button {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
        }
        
        /* ë¶„ì„ ì°¨íŠ¸ íƒ­ & ì„œë¸Œ íƒ­ */
        .analysis-tabs, .sub-tabs {
            display: flex;
            gap: 4px;
            overflow-x: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .analysis-tabs::-webkit-scrollbar, .sub-tabs::-webkit-scrollbar {
            display: none;
        }
        .analysis-tabs {
            border-bottom: 1px solid var(--card-border);
            margin-bottom: 16px;
        }
        .sub-tabs {
            padding-bottom: 12px;
        }
        .analysis-tab {
            padding: 8px 4px;
            font-size: 14px;
            font-weight: 500;
            color: var(--muted-foreground);
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
        }
        .analysis-tab.active {
            color: var(--primary-color);
            font-weight: 700;
            border-bottom-color: var(--primary-color);
        }
        .analysis-content {
            display: none;
        }
        .analysis-content.active {
            display: block;
        }
        .sub-tab {
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 500;
            border-radius: 9999px;
            background-color: #f3f4f6;
            color: #4b5563;
            border: none;
            cursor: pointer;
            white-space: nowrap;
        }
        .sub-tab.active {
            background-color: #eef2ff;
            color: #4338ca;
            font-weight: 700;
        }


        /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” */
        .bottom-nav {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background-color: #ffffff;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid var(--card-border);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--muted-foreground);
            font-size: 11px;
            font-weight: 500;
            text-decoration: none;
        }
        .nav-item.active {
            color: var(--primary-color);
        }
        .nav-item svg {
            width: 24px;
            height: 24px;
        }
    </style>
</head>
<body>
    <div class="phone-container">
        <div class="content">
            <!-- í˜ì´ì§€ íƒ€ì´í‹€ -->
            <div style="padding: 0 4px 16px;">
                <h1 style="font-size: 22px; font-weight: 800;">'ë„‰ë„‰í•œ ìœ¤ë¦¬ìŒ¤'ë‹˜<br>AI ì¬ë¬´ì„¤ê³„</h1>
                <p style="font-size: 12px; color: var(--muted-foreground); margin-top: 4px;">ë¶„ì„ ê¸°ì¤€ì¼: <span id="asof"></span></p>
            </div>

            <!-- KPIs -->
            <div class="card kpi-card">
                <div class="card-header">
                    <h2 class="card-title">ğŸ“ˆ ì†PB ì¬ë¬´ì„¤ê³„ ìš”ì•½</h2>
                    <p class="card-desc">AIê°€ ë¶„ì„í•œ ì›” íˆ¬ì ê³„íšì…ë‹ˆë‹¤.</p>
                </div>
                <div class="card-content">
                    <div class="kpi-grid">
                        <div class="kpi-item" style="background-color: #f0f5ff;">
                            <div class="kpi-label">ì´ ì›” íˆ¬ìê¸ˆ</div>
                            <div id="kpi-monthly" class="kpi-value" style="color: #4338ca;">-</div>
                        </div>
                        <div class="kpi-item" style="background-color: #f0fdf4;">
                            <div class="kpi-label">ì„¤ì •ëœ ëª©í‘œ</div>
                            <div id="kpi-goalcount" class="kpi-value" style="color: #15803d;">-</div>
                        </div>
                        <div class="kpi-item" style="background-color: #fffbeb;">
                            <div class="kpi-label">ìµœì¥ê¸° ëª©í‘œ</div>
                            <div id="kpi-maxhorizon" class="kpi-value" style="color: #b45309;">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Goals -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ğŸ¯ ì†PB ì¶”ì²œ ì¬ë¬´ëª©í‘œ</h2>
                    <p class="card-desc">ì¬ë¬´ì„¤ê³„ ì „ë¬¸ê°€ ì†PBê°€ ë§ì¶¤í˜• ì¬ë¬´ëª©í‘œë¥¼ ë„ì¶œí–ˆì–´ìš”.</p>
                </div>
                <div id="goal-grid" class="card-content" style="padding-top: 0;"></div>
            </div>
            
            <!-- ëª©í‘œ ë‹¬ì„± ë¶„ì„ (ì‹œë®¬ë ˆì´ì…˜ & ë°±í…ŒìŠ¤íŒ…) -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ğŸ”¬ ëª©í‘œ ë‹¬ì„± ë¶„ì„</h2>
                    <p class="card-desc">AIê°€ ì˜ˆì¸¡í•œ ë¯¸ë˜ ìì‚°ê³¼ ê³¼ê±° ì„±ê³¼ì…ë‹ˆë‹¤.</p>
                </div>
                <div class="card-content">
                    <div class="analysis-tabs">
                        <button id="show-sim" class="analysis-tab active">ì‹œë®¬ë ˆì´ì…˜</button>
                        <button id="show-bt" class="analysis-tab">ë°±í…ŒìŠ¤íŒ…</button>
                    </div>
                    <div id="sim-content" class="analysis-content active">
                        <div id="sim-tabs" class="sub-tabs"></div>
                        <div id="sim-chart" style="height: 250px; margin-top: 16px;"></div>
                    </div>
                    <div id="bt-content" class="analysis-content">
                        <div id="bt-tabs" class="sub-tabs"></div>
                        <div id="bt-chart" style="height: 250px; margin-top: 16px;"></div>
                    </div>
                </div>
            </div>


            <!-- Portfolio Pie -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ğŸ“Š ì¶”ì²œ ì›” íˆ¬ì í¬íŠ¸í´ë¦¬ì˜¤</h2>
                    <p class="card-desc">ë§ì¶¤ ì¬ë¬´ëª©í‘œ ë‹¬ì„±ì„ ìœ„í•œ ì›” íˆ¬ì í¬íŠ¸í´ë¦¬ì˜¤ì…ë‹ˆë‹¤</p>
                </div>
                <div class="card-content">
                    <div id="portfolio-tabs" class="sub-tabs"></div>
                    <div id="pie-chart" style="height: 200px; margin-top: 16px;"></div>
                    <div id="pie-legend" style="margin-top: 16px;"></div>
                </div>
            </div>

            <!-- AI Briefing -->
            <div class="card ai-briefing-card">
                <div class="card-header" style="border: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h2 class="card-title">âœ¨ ì†PB AI ì¢…í•© ë¸Œë¦¬í•‘</h2>
                            <p class="card-desc">ë²„íŠ¼ì„ ëˆŒëŸ¬ ìš”ì•½ì„ ìƒì„±í•˜ì„¸ìš”.</p>
                        </div>
                        <button id="btn-brief" class="refresh-button">ğŸ”„</button>
                    </div>
                </div>
                <div class="card-content">
                    <div id="briefing">ìš°ì¸¡ ìƒë‹¨ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¸Œë¦¬í•‘ì„ ìƒì„±í•˜ì„¸ìš”.</div>
                </div>
            </div>
        </div>
        
        <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
        <nav class="bottom-nav">
            <a href="#" class="nav-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                <span>í™ˆ</span>
            </a>
            <a href="#" class="nav-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="5" rx="2"></rect><line x1="2" x2="22" y1="10" y2="10"></line></svg>
                <span>AI ê°€ê³„ë¶€</span>
            </a>
            <a href="#" class="nav-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                <span>AI ìì‚°ê´€ë¦¬</span>
            </a>
            <a href="#" class="nav-item active">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                <span>AI ì¬ë¬´ì„¤ê³„</span>
            </a>
        </nav>
    </div>

    <script>
        // ====== Raw Data ======
        const customerDataYoonRaw = {
            lastUpdated: "2025-08-27T22:00:20.690397",
            customerInfo: { age: 30 },
            goals: [
                { id: "G0", name: "ì€í‡´ ìê¸ˆ ë§ˆë ¨(ì•½ 6ì–µì›)", horizonMonths: 420, targetKRW: 496529103, monthlyInvestKRW: 66519, expectedFinalKRW: 608906904, rationale: "ì•ˆì •ì ì¸ ë…¸í›„ ìƒí™œì„ ìœ„í•œ ì¥ê¸° íˆ¬ì í”Œëœì˜ í•µì‹¬" },
                { id: "G1", name: "ë‹¨ê¸° ì €ì¶• ëª©í‘œ", horizonMonths: 60, targetKRW: 100000000, monthlyInvestKRW: 1169229, expectedFinalKRW: 102463095, rationale: "5ë…„ ë‚´ ëª©ëˆ ë§ˆë ¨ì„ ìœ„í•œ ê°€ì¥ ìš°ì„ ìˆœìœ„ê°€ ë†’ì€ ë‹¨ê¸° ì§‘ì¤‘ ëª©í‘œì…ë‹ˆë‹¤." },
                { id: "G2", name: "ì—¬í–‰ ìê¸ˆ", horizonMonths: 12, targetKRW: 20000000, monthlyInvestKRW: 125855, expectedFinalKRW: 1594986, rationale: "ì‚¶ì˜ ì§ˆ í–¥ìƒì„ ìœ„í•œ ì—° ë‹¨ìœ„ì˜ ë‹¨ê¸° ì¬ì¶©ì „ ëª©í‘œì…ë‹ˆë‹¤." },
                { id: "G5", name: "ì²­ë…„ ì£¼íƒë“œë¦¼ ì²­ì•½", horizonMonths: null, targetKRW: null, monthlyInvestKRW: 100000, expectedFinalKRW: null, rationale: "ë‚´ ì§‘ ë§ˆë ¨ì˜ ì´ˆì„ì´ ë˜ëŠ” ì •ë¶€ ì§€ì› ì •ì±… í™œìš© ê·¹ëŒ€í™” ëª©í‘œì…ë‹ˆë‹¤." },
                { id: "G6", name: "í˜„ê¸ˆì„± ìì‚° (ìœ ë™ì„±)", horizonMonths: null, targetKRW: null, monthlyInvestKRW: 151289, expectedFinalKRW: null, rationale: "ì˜ˆìƒì¹˜ ëª»í•œ ì§€ì¶œì— ëŒ€ë¹„í•˜ê³  íˆ¬ì ê¸°íšŒë¥¼ í¬ì°©í•˜ê¸° ìœ„í•œ ë¹„ìƒê¸ˆì…ë‹ˆë‹¤." }
            ],
            portfolio_amount: [
                { "ì¬ë¬´ ëª©í‘œ": "ì€í‡´ ìê¸ˆ ë§ˆë ¨", "KODEX ë¯¸êµ­ë‚˜ìŠ¤ë‹¥100": 26300, "TIGER KRXê¸ˆí˜„ë¬¼": 32500, "TIGER ìš°ëŸ‰íšŒì‚¬ì±„ì•¡í‹°ë¸Œ": 7800, "ì²­ë…„ë„ì•½ê³„ì¢Œ": 0, "ì²­ë…„ ì£¼íƒë“œë¦¼ ì²­ì•½í†µì¥": 0, "í˜„ê¸ˆ": 0 },
                { "ì¬ë¬´ ëª©í‘œ": "ë‹¨ê¸° ì €ì¶• ëª©í‘œ", "KODEX ë¯¸êµ­ë‚˜ìŠ¤ë‹¥100": 576600, "TIGER KRXê¸ˆí˜„ë¬¼": 335400, "TIGER ìš°ëŸ‰íšŒì‚¬ì±„ì•¡í‹°ë¸Œ": 0, "ì²­ë…„ë„ì•½ê³„ì¢Œ": 257000, "ì²­ë…„ ì£¼íƒë“œë¦¼ ì²­ì•½í†µì¥": 0, "í˜„ê¸ˆ": 0 },
                { "ì¬ë¬´ ëª©í‘œ": "ì—¬í–‰ ìê¸ˆ", "KODEX ë¯¸êµ­ë‚˜ìŠ¤ë‹¥100": 37700, "TIGER KRXê¸ˆí˜„ë¬¼": 0, "TIGER ìš°ëŸ‰íšŒì‚¬ì±„ì•¡í‹°ë¸Œ": 0, "ì²­ë…„ë„ì•½ê³„ì¢Œ": 88000, "ì²­ë…„ ì£¼íƒë“œë¦¼ ì²­ì•½í†µì¥": 0, "í˜„ê¸ˆ": 0 },
                { "ì¬ë¬´ ëª©í‘œ": "ì²­ë…„ ì£¼íƒë“œë¦¼ ì²­ì•½í†µì¥", "KODEX ë¯¸êµ­ë‚˜ìŠ¤ë‹¥100": 0, "TIGER KRXê¸ˆí˜„ë¬¼": 0, "TIGER ìš°ëŸ‰íšŒì‚¬ì±„ì•¡í‹°ë¸Œ": 0, "ì²­ë…„ë„ì•½ê³„ì¢Œ": 0, "ì²­ë…„ ì£¼íƒë“œë¦¼ ì²­ì•½í†µì¥": 100000, "í˜„ê¸ˆ": 0 },
                { "ì¬ë¬´ ëª©í‘œ": "í˜„ê¸ˆ", "KODEX ë¯¸êµ­ë‚˜ìŠ¤ë‹¥100": 0, "TIGER KRXê¸ˆí˜„ë¬¼": 0, "TIGER ìš°ëŸ‰íšŒì‚¬ì±„ì•¡í‹°ë¸Œ": 0, "ì²­ë…„ë„ì•½ê³„ì¢Œ": 0, "ì²­ë…„ ì£¼íƒë“œë¦¼ ì²­ì•½í†µì¥": 0, "í˜„ê¸ˆ": 151289 },
                { "ì¬ë¬´ ëª©í‘œ": "ì¢…í•©", "KODEX ë¯¸êµ­ë‚˜ìŠ¤ë‹¥100": 640600, "TIGER KRXê¸ˆí˜„ë¬¼": 367900, "TIGER ìš°ëŸ‰íšŒì‚¬ì±„ì•¡í‹°ë¸Œ": 7800, "ì²­ë…„ë„ì•½ê³„ì¢Œ": 345000, "ì²­ë…„ ì£¼íƒë“œë¦¼ ì²­ì•½í†µì¥": 100000, "í˜„ê¸ˆ": 151289 }
            ],
            portfolio_perc: [
                { "ì¬ë¬´ ëª©í‘œ": "ì€í‡´ ìê¸ˆ ë§ˆë ¨", "KODEX ë¯¸êµ­ë‚˜ìŠ¤ë‹¥100": 39.5, "TIGER KRXê¸ˆí˜„ë¬¼": 48.8, "TIGER ìš°ëŸ‰íšŒì‚¬ì±„ì•¡í‹°ë¸Œ": 11.7, "ì²­ë…„ë„ì•½ê³„ì¢Œ": 0.0, "ì²­ë…„ ì£¼íƒë“œë¦¼ ì²­ì•½í†µì¥": 0.0, "í˜„ê¸ˆ": 0.0 },
                { "ì¬ë¬´ ëª©í‘œ": "ë‹¨ê¸° ì €ì¶• ëª©í‘œ", "KODEX ë¯¸êµ­ë‚˜ìŠ¤ë‹¥100": 49.3, "TIGER KRXê¸ˆí˜„ë¬¼": 28.7, "TIGER ìš°ëŸ‰íšŒì‚¬ì±„ì•¡í‹°ë¸Œ": 0.0, "ì²­ë…„ë„ì•½ê³„ì¢Œ": 22.0, "ì²­ë…„ ì£¼íƒë“œë¦¼ ì²­ì•½í†µì¥": 0.0, "í˜„ê¸ˆ": 0.0 },
                { "ì¬ë¬´ ëª©í‘œ": "ì—¬í–‰ ìê¸ˆ", "KODEX ë¯¸êµ­ë‚˜ìŠ¤ë‹¥100": 30.0, "TIGER KRXê¸ˆí˜„ë¬¼": 0.0, "TIGER ìš°ëŸ‰íšŒì‚¬ì±„ì•¡í‹°ë¸Œ": 0.0, "ì²­ë…„ë„ì•½ê³„ì¢Œ": 70.0, "ì²­ë…„ ì£¼íƒë“œë¦¼ ì²­ì•½í†µì¥": 0.0, "í˜„ê¸ˆ": 0.0 },
                { "ì¬ë¬´ ëª©í‘œ": "ì²­ë…„ ì£¼íƒë“œë¦¼ ì²­ì•½í†µì¥", "KODEX ë¯¸êµ­ë‚˜ìŠ¤ë‹¥100": 0.0, "TIGER KRXê¸ˆí˜„ë¬¼": 0.0, "TIGER ìš°ëŸ‰íšŒì‚¬ì±„ì•¡í‹°ë¸Œ": 0.0, "ì²­ë…„ë„ì•½ê³„ì¢Œ": 0.0, "ì²­ë…„ ì£¼íƒë“œë¦¼ ì²­ì•½í†µì¥": 100.0, "í˜„ê¸ˆ": 0.0 },
                { "ì¬ë¬´ ëª©í‘œ": "í˜„ê¸ˆ", "KODEX ë¯¸êµ­ë‚˜ìŠ¤ë‹¥100": 0.0, "TIGER KRXê¸ˆí˜„ë¬¼": 0.0, "TIGER ìš°ëŸ‰íšŒì‚¬ì±„ì•¡í‹°ë¸Œ": 0.0, "ì²­ë…„ë„ì•½ê³„ì¢Œ": 0.0, "ì²­ë…„ ì£¼íƒë“œë¦¼ ì²­ì•½í†µì¥": 0.0, "í˜„ê¸ˆ": 100.0 },
                { "ì¬ë¬´ ëª©í‘œ": "ì¢…í•©", "KODEX ë¯¸êµ­ë‚˜ìŠ¤ë‹¥100": 39.7, "TIGER KRXê¸ˆí˜„ë¬¼": 22.8, "TIGER ìš°ëŸ‰íšŒì‚¬ì±„ì•¡í‹°ë¸Œ": 0.5, "ì²­ë…„ë„ì•½ê³„ì¢Œ": 21.4, "ì²­ë…„ ì£¼íƒë“œë¦¼ ì²­ì•½í†µì¥": 6.2, "í˜„ê¸ˆ": 9.4 }
            ],
            backtestResults: {
                G0: {
                    period: "2016-2025", metrics: { CAGR: 0.131, maxDD: -0.183, sharpe: 1.15 },
                    equityCurve: [ { year: 2016, "ë‚˜ì˜ í¬íŠ¸í´ë¦¬ì˜¤": 839298, "S&P 500": 849766 }, { year: 2017, "ë‚˜ì˜ í¬íŠ¸í´ë¦¬ì˜¤": 1862351, "S&P 500": 1881506 }, { year: 2018, "ë‚˜ì˜ í¬íŠ¸í´ë¦¬ì˜¤": 2954534, "S&P 500": 2495084 }, { year: 2019, "ë‚˜ì˜ í¬íŠ¸í´ë¦¬ì˜¤": 4718677, "S&P 500": 4094117 }, { year: 2020, "ë‚˜ì˜ í¬íŠ¸í´ë¦¬ì˜¤": 5983567, "S&P 500": 5698885 }, { year: 2021, "ë‚˜ì˜ í¬íŠ¸í´ë¦¬ì˜¤": 7624854, "S&P 500": 8122749 }, { year: 2022, "ë‚˜ì˜ í¬íŠ¸í´ë¦¬ì˜¤": 8510854, "S&P 500": 7296111 }, { year: 2023, "ë‚˜ì˜ í¬íŠ¸í´ë¦¬ì˜¤": 10693583, "S&P 500": 9944178 }, { year: 2024, "ë‚˜ì˜ í¬íŠ¸í´ë¦¬ì˜¤": 13335888, "S&P 500": 13121304 }, { year: 2025, "ë‚˜ì˜ í¬íŠ¸í´ë¦¬ì˜¤": 15045528, "S&P 500": 14637088 } ]
                },
                G1: {
                    period: "2016-2020", metrics: { CAGR: 0.082, maxDD: -0.11, sharpe: 0.85 },
                    equityCurve: [ { year: 2016, "ë‚˜ì˜ í¬íŠ¸í´ë¦¬ì˜¤": 14752597, "S&P 500": 14936597 }, { year: 2017, "ë‚˜ì˜ í¬íŠ¸í´ë¦¬ì˜¤": 32638167, "S&P 500": 33071802 }, { year: 2018, "ë‚˜ì˜ í¬íŠ¸í´ë¦¬ì˜¤": 50826714, "S&P 500": 43856840 }, { year: 2019, "ë‚˜ì˜ í¬íŠ¸í´ë¦¬ì˜¤": 74556252, "S&P 500": 71963525 }, { year: 2020, "ë‚˜ì˜ í¬íŠ¸í´ë¦¬ì˜¤": 92075737, "S&P 500": 100171007 } ]
                }
            }
        };

        // ====== Utilities ======
        const krw = (n) => new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW', maximumFractionDigits: 0 }).format(Number.isFinite(n) ? n : 0);
        const kFormat = (v) => v >= 100000000 ? `${(v/100000000).toFixed(1).replace(/\.0$/, '')}ì–µ` : (v >= 10000 ? `${Math.round(v/10000)}ë§Œ` : `${v}`);
        const pct = (x, d = 1) => `${(((Number.isFinite(x)?x:0) * 100)).toFixed(d)}%`;

        function buildAssetsFromTables(amount, perc, goalName) {
            try {
                const sumRow = (amount || []).find(r => r["ì¬ë¬´ ëª©í‘œ"] === goalName);
                if (!sumRow) return [];
                const assets = Object.keys(sumRow).filter(k => k !== 'ì¬ë¬´ ëª©í‘œ' && sumRow[k] > 0);
                const percRow = (perc || []).find(r => r["ì¬ë¬´ ëª©í‘œ"] === goalName) || {};
                return assets.map(symbol => ({ 
                    symbol, 
                    monthlyKRW: Number(sumRow[symbol] || 0), 
                    weight: Number(percRow[symbol] || 0) / 100 
                }));
            } catch(e) { console.warn(e); return []; }
        }

        function ensureDataShape(raw) {
            const d = raw && typeof raw === 'object' ? raw : {};
            const totalAssets = buildAssetsFromTables(d.portfolio_amount, d.portfolio_perc, "ì¢…í•©");
            const monthlyBudgetKRW = totalAssets.reduce((s, a) => s + a.monthlyKRW, 0);
            return {
                lastUpdated: d.lastUpdated || new Date().toISOString(),
                customerInfo: d.customerInfo || { age: 30 },
                goals: Array.isArray(d.goals) ? d.goals : [],
                portfolio: { 
                    monthlyBudgetKRW, 
                    assets: totalAssets,
                    byGoal: (d.portfolio_amount || []).reduce((acc, row) => {
                        const goalName = row["ì¬ë¬´ ëª©í‘œ"];
                        if (goalName !== "ì¢…í•©") {
                           acc[goalName] = buildAssetsFromTables(d.portfolio_amount, d.portfolio_perc, goalName);
                        }
                        return acc;
                    }, {})
                },
                backtestResults: d.backtestResults || {}
            };
        }

        // ====== State ======
        const state = ensureDataShape(customerDataYoonRaw);
        const palette = ['#4f46e5', '#10b981', '#3b82f6', '#8b5cf6', '#a8a29e', '#f59e0b', '#ef4444', '#06b6d4'];
        
        // ====== Gemini API Function ======
        async function callGeminiAPI(prompt) {
            const apiKey = ""; // API í‚¤ëŠ” ë¹„ì›Œë‘ì„¸ìš”.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                return "ë¸Œë¦¬í•‘ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
            }
        }


        // ====== DOM Ready ======
        document.addEventListener('DOMContentLoaded', () => {
            // DOM refs
            const asof = document.getElementById('asof');
            const kpiMonthly = document.getElementById('kpi-monthly');
            const kpiGoalCount = document.getElementById('kpi-goalcount');
            const kpiMaxHorizon = document.getElementById('kpi-maxhorizon');
            const goalGrid = document.getElementById('goal-grid');
            const pieLegend = document.getElementById('pie-legend');
            const pieChartEl = document.getElementById('pie-chart');
            const btnBrief = document.getElementById('btn-brief');
            const briefing = document.getElementById('briefing');
            const simChartEl = document.getElementById('sim-chart');
            const btChartEl = document.getElementById('bt-chart');
            const portfolioTabs = document.getElementById('portfolio-tabs');

            let pieChart, simChart, btChart;

            // Init Basics
            asof.textContent = new Date(state.lastUpdated).toLocaleDateString('ko-KR');
            kpiMonthly.textContent = krw(state.portfolio.monthlyBudgetKRW);
            kpiGoalCount.textContent = `${state.goals.length}ê°œ`;
            const maxMonths = Math.max(...state.goals.map(g => g.horizonMonths || 0));
            kpiMaxHorizon.textContent = `${maxMonths/12}ë…„`;

            // Goal Cards
            state.goals.forEach(g => {
                const card = document.createElement('div');
                card.className = 'goal-card';
                card.innerHTML = `
                    <div class="goal-header">
                        <h3 class="goal-name">${g.name}</h3>
                        ${g.targetKRW ? `<span class="goal-badge">P${g.id.replace('G','')}</span>` : ''}
                    </div>
                    <p class="goal-rationale">${g.rationale || ''}</p>
                    <div class="goal-details">
                        <div>
                            <p class="detail-label">ì›” íˆ¬ìê¸ˆ</p>
                            <p class="detail-value">${krw(g.monthlyInvestKRW)}</p>
                        </div>
                        <div>
                            <p class="detail-label">ëª©í‘œ ê¸°ê°„</p>
                            <p class="detail-value">${g.horizonMonths ? (g.horizonMonths/12 + ' ë…„') : 'N/A'}</p>
                        </div>
                        <div>
                            <p class="detail-label">ìµœì¢… ì˜ˆìƒì•¡</p>
                            <p class="detail-value highlight">${g.expectedFinalKRW ? krw(g.expectedFinalKRW) : 'N/A'}</p>
                        </div>
                    </div>`;
                goalGrid.appendChild(card);
            });

            // Portfolio Pie Chart Logic
            if (pieChartEl) {
                pieChart = echarts.init(pieChartEl);
                const portfolioTabDefs = [
                    { id: 'ì¢…í•©', label: 'ì¢…í•©' },
                    { id: 'ì€í‡´ ìê¸ˆ ë§ˆë ¨', label: 'ì€í‡´ ìê¸ˆ' },
                    { id: 'ë‹¨ê¸° ì €ì¶• ëª©í‘œ', label: 'ë‹¨ê¸° ì €ì¶•' },
                    { id: 'ì—¬í–‰ ìê¸ˆ', label: 'ì—¬í–‰ ìê¸ˆ' }
                ];
                let portfolioActive = 'ì¢…í•©';

                function renderPortfolioTabs() {
                    portfolioTabs.innerHTML = '';
                    portfolioTabDefs.forEach(def => {
                        const btn = document.createElement('button');
                        btn.className = `sub-tab ${portfolioActive === def.id ? 'active' : ''}`;
                        btn.textContent = def.label;
                        btn.addEventListener('click', () => {
                            portfolioActive = def.id;
                            drawPieChart();
                            renderPortfolioTabs();
                        });
                        portfolioTabs.appendChild(btn);
                    });
                }

                function drawPieChart() {
                    const assets = portfolioActive === 'ì¢…í•©' ? state.portfolio.assets : state.portfolio.byGoal[portfolioActive] || [];
                    const pieData = assets.map((a, i) => ({ 
                        value: a.monthlyKRW, 
                        name: a.symbol, 
                        itemStyle: { color: palette[i % palette.length] }
                    }));
                    
                    pieChart.setOption({
                        tooltip: { trigger: 'item', formatter: ({name, value, percent}) => `${name}<br/>${krw(value)} (${percent}%)` },
                        series: [{
                            name: 'í¬íŠ¸í´ë¦¬ì˜¤', type: 'pie', radius: ['50%','75%'], avoidLabelOverlap: true, padAngle: 3,
                            label: { show: false }, labelLine: { show: false }, data: pieData
                        }]
                    }, true);

                    const totalForLegend = assets.reduce((sum, asset) => sum + asset.monthlyKRW, 0);
                    pieLegend.innerHTML = assets.map((a, i) => {
                        const weight = totalForLegend > 0 ? a.monthlyKRW / totalForLegend : 0;
                        return `
                        <div class="pie-legend-item">
                            <div class="legend-info">
                                <span class="legend-dot" style="background:${palette[i % palette.length]}"></span>
                                <span>${a.symbol}</span>
                            </div>
                            <div class="legend-value">${krw(a.monthlyKRW)} <span>(${pct(weight)})</span></div>
                        </div>`
                    }).join('');
                }
                
                renderPortfolioTabs();
                drawPieChart();
            }


            // AI Briefing
            btnBrief.addEventListener('click', async () => {
                btnBrief.disabled = true; 
                briefing.textContent = 'âœ¨ AIê°€ ë¸Œë¦¬í•‘ì„ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
                
                const goalsSummary = state.goals.map(g => `- ${g.name} (ê¸°ê°„: ${g.horizonMonths ? g.horizonMonths/12 + 'ë…„' : 'ì§€ì†'}, ì›” ${krw(g.monthlyInvestKRW)})`).join('\n');
                const portfolioSummary = state.portfolio.assets.map(a => `- ${a.symbol}: ${pct(a.weight)}`).join('\n');

                const prompt = `ë‹¹ì‹ ì€ ì „ë¬¸ ê¸ˆìœµ ì–´ë“œë°”ì´ì € 'ì†PB'ì…ë‹ˆë‹¤. ë‹¤ìŒ ê³ ê° ë°ì´í„°ëŠ” ê³ ê°ì˜ í˜„ì¬ ìì‚°ì´ ì•„ë‹Œ, ìš°ë¦¬ê°€ ê³ ê°ì˜ ì¬ë¬´ ëª©í‘œ ë‹¬ì„±ì„ ìœ„í•´ ì¶”ì²œí•˜ëŠ” 'ì¶”ì²œ í¬íŠ¸í´ë¦¬ì˜¤'ì…ë‹ˆë‹¤. ì´ ì¶”ì²œ í¬íŠ¸í´ë¦¬ì˜¤ê°€ ì™œ ê³ ê°ì—ê²Œ ì í•©í•œì§€ ì¹œì ˆí•˜ê³  ì´í•´í•˜ê¸° ì‰½ê²Œ ì„¤ëª…í•˜ëŠ” ì¢…í•© ë¸Œë¦¬í•‘ì„ ì‘ì„±í•´ì£¼ì„¸ìš”. ê²°ê³¼ëŠ” HTML í˜•ì‹ìœ¼ë¡œ, ê° ì„¹ì…˜ ì œëª©ì€ <strong> íƒœê·¸ë¡œ ê°ì‹¸ì£¼ì„¸ìš”.

### ê³ ê° ë°ì´í„°
- **ì´ ì›” íˆ¬ìê¸ˆ**: ${krw(state.portfolio.monthlyBudgetKRW)}
- **ì¬ë¬´ ëª©í‘œ**:
${goalsSummary}
- **ì¶”ì²œ ì›” íˆ¬ì í¬íŠ¸í´ë¦¬ì˜¤ (ì¢…í•©)**:
${portfolioSummary}

### ë¸Œë¦¬í•‘ ë‚´ìš©
1.  **ìš”ì•½**: ì´ í¬íŠ¸í´ë¦¬ì˜¤ì˜ í•µì‹¬ ì „ëµì„ í•œë‘ ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”. (ì˜ˆ: ì•ˆì •ì ì¸ ì •ë¶€ ì§€ì› ìƒí’ˆê³¼ ì¥ê¸° ì„±ì¥ ìì‚°ì„ ê²°í•©í•˜ì—¬...)
2.  **ëª©í‘œì™€ í¬íŠ¸í´ë¦¬ì˜¤ ì—°ê²°**: ê° ì¬ë¬´ ëª©í‘œ ë‹¬ì„±ì„ ìœ„í•´ í¬íŠ¸í´ë¦¬ì˜¤ì˜ ì–´ë–¤ ìì‚°ì´ ì–´ë–»ê²Œ ê¸°ì—¬í•˜ëŠ”ì§€ ì„¤ëª…í•´ì£¼ì„¸ìš”. (ì˜ˆ: 'ì€í‡´ ìê¸ˆ ë§ˆë ¨'ì„ ìœ„í•´ 'KODEX ë¯¸êµ­ë‚˜ìŠ¤ë‹¥100'ì—, 'ë‹¨ê¸° ì €ì¶• ëª©í‘œ'ë¥¼ ìœ„í•´ 'ì²­ë…„ë„ì•½ê³„ì¢Œ'ì— íˆ¬ìí•©ë‹ˆë‹¤.)
3.  **ì œì–¸**: ì´ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ê¾¸ì¤€íˆ ìœ ì§€í–ˆì„ ë•Œ ê¸°ëŒ€í•  ìˆ˜ ìˆëŠ” ê¸ì •ì ì¸ ë¯¸ë˜ì— ëŒ€í•´ ì–¸ê¸‰í•˜ë©° ê²©ë ¤í•´ì£¼ì„¸ìš”.`;

                const result = await callGeminiAPI(prompt);
                briefing.innerHTML = result;
                btnBrief.disabled = false;
            });
            
            // --- Analysis Charts ---
            simChart = echarts.init(simChartEl);
            btChart = echarts.init(btChartEl);
            
            // Main Tabs
            document.getElementById('show-sim').addEventListener('click', (e) => {
                document.getElementById('show-bt').classList.remove('active');
                e.target.classList.add('active');
                document.getElementById('bt-content').classList.remove('active');
                document.getElementById('sim-content').classList.add('active');
                simChart.resize();
            });
            document.getElementById('show-bt').addEventListener('click', (e) => {
                document.getElementById('show-sim').classList.remove('active');
                e.target.classList.add('active');
                document.getElementById('sim-content').classList.remove('active');
                document.getElementById('bt-content').classList.add('active');
                btChart.resize();
            });

            // Simulation Logic
            const { seriesAll, seriesMap } = buildSimulationSeries();
            const simTabs = document.getElementById('sim-tabs');
            const simTabDefs = [{ id: 'all', label: 'ì¢…í•©' }, ...state.goals.filter(g=>g.horizonMonths).map(g => ({ id: g.id, label: g.name }))];
            let simActive = 'all';

            function renderSimTabs() {
                simTabs.innerHTML = '';
                simTabDefs.forEach(def => {
                    const btn = document.createElement('button');
                    btn.className = `sub-tab ${simActive===def.id ? 'active' : ''}`;
                    btn.textContent = def.label;
                    btn.addEventListener('click', () => { simActive = def.id; drawSim(); renderSimTabs(); });
                    simTabs.appendChild(btn);
                });
            }

            function drawSim() {
                const option = {
                    grid: { left: 50, right: 20, top: 20, bottom: 30 },
                    xAxis: { 
                        type: 'value', 
                        min: state.customerInfo.age,
                        axisLabel: { formatter: val => `${Math.floor(val)}ì„¸` } 
                    },
                    yAxis: { 
                        type: 'value', 
                        axisLabel: { formatter: kFormat } 
                    },
                    tooltip: { trigger: 'axis', valueFormatter: v => krw(v) }
                };
                if (simActive === 'all') {
                    option.series = [{ name: 'ì´ ìì‚°', type: 'line', areaStyle: {}, showSymbol: false, itemStyle: { color: '#007aff' }, data: seriesAll }];
                } else {
                    const data = seriesMap[simActive] || [];
                    option.series = [
                        { name: 'ì˜ˆìƒ ìì‚°', type: 'line', areaStyle: {}, showSymbol: false, itemStyle: { color: '#007aff' }, data: data.map(([age, v]) => [age, v]) },
                        { name: 'ëª©í‘œ ê¸ˆì•¡', type: 'line', showSymbol: false, itemStyle: { color: '#a8a29e' }, lineStyle: { type: 'dashed' }, data: data.map(([age, , t]) => [age, t]) }
                    ];
                }
                simChart.setOption(option, true);
            }
            
            function buildSimulationSeries() {
                const goals = state.goals;
                const cagr = 0.07;
                const mRate = Math.pow(1 + cagr, 1/12) - 1;
                const finite = goals.filter(g => g.horizonMonths);
                const maxH = finite.length ? Math.max(...finite.map(g => g.horizonMonths)) : 0;
                const seriesAll = [];
                const seriesMap = {};
                const values = {};
                goals.forEach(g => { if (g.horizonMonths) { seriesMap[g.id] = []; values[g.id] = 0; } });
                
                let total = 0;
                for (let m=1; m<=maxH; m++) {
                    let monthlyInvestTotal = 0;
                    const age = state.customerInfo.age + m/12;
                    goals.forEach(g => {
                        if (g.horizonMonths && m <= g.horizonMonths) {
                            values[g.id] = values[g.id] * (1+mRate) + g.monthlyInvestKRW;
                            seriesMap[g.id].push([Number(age.toFixed(2)), values[g.id], g.targetKRW]);
                            monthlyInvestTotal += g.monthlyInvestKRW;
                        }
                    });
                    total = total * (1+mRate) + monthlyInvestTotal;
                    seriesAll.push([Number(age.toFixed(2)), total]);
                }
                return { seriesAll, seriesMap };
            }

            renderSimTabs();
            drawSim();

            // Backtest Logic
            const btTabs = document.getElementById('bt-tabs');
            const btDefs = Object.keys(state.backtestResults).map(k => ({ id: k, label: (state.goals.find(g=>g.id===k)?.name) || k }));
            let btActive = btDefs[0]?.id || 'G0';

            function renderBtTabs() {
                btTabs.innerHTML = '';
                btDefs.forEach(def => {
                    const btn = document.createElement('button');
                    btn.className = `sub-tab ${btActive===def.id ? 'active' : ''}`;
                    btn.textContent = def.label;
                    btn.addEventListener('click', () => { btActive = def.id; drawBt(); renderBtTabs(); });
                    btTabs.appendChild(btn);
                });
            }

            function drawBt() {
                const res = state.backtestResults[btActive];
                if (!res) return;
                const curve = res.equityCurve;
                const mkSeries = (key, color, dash) => ({
                    name: key, type: 'line', data: curve.map(d => [d.year, d[key]]), showSymbol: false,
                    lineStyle: { color, type: dash || 'solid', width: key==='ë‚˜ì˜ í¬íŠ¸í´ë¦¬ì˜¤'? 2.5 : 1.5 },
                });

                btChart.setOption({
                    legend: { top: 0, textStyle: { fontSize: 11 } },
                    grid: { left: 50, right: 20, top: 30, bottom: 30 },
                    xAxis: { type: 'value', axisLabel: { formatter: v => v } },
                    yAxis: { type: 'value', axisLabel: { formatter: kFormat } },
                    tooltip: { trigger: 'axis', valueFormatter: v => krw(v) },
                    series: [
                        mkSeries('ë‚˜ì˜ í¬íŠ¸í´ë¦¬ì˜¤', '#007aff', 'solid'),
                        mkSeries('S&P 500', '#a8a29e', 'dashed'),
                    ]
                });
            }

            renderBtTabs();
            drawBt();
            
            window.addEventListener('resize', () => {
                if(pieChart) pieChart.resize();
                if(simChart) simChart.resize();
                if(btChart) btChart.resize();
            });
        });
    </script>
</body>
</html>
